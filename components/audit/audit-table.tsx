'use client'

import { useMemo, useState, useEffect } from 'react'
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'
import { Input } from '@/components/ui/input'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Button } from '@/components/ui/button'
import { cn } from '@/lib/utils'
import { createClient } from '@/lib/supabase/client'
import { UserRole } from '@/lib/auth'
import { getAuditPDFDownloadUrl, deleteAuditPDF } from '@/app/actions/audit-pdfs'
import { Upload, Eye, EyeOff, File, Trash2, SlidersHorizontal, ChevronDown, ChevronUp } from 'lucide-react'
import { PDFViewerModal } from '@/components/shared/pdf-viewer-modal'
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog'
import { 
  AuditRow, 
  pctBadge, 
  boolBadge, 
  formatDate, 
  getLatestPct, 
  getLatestPctForSort 
} from './audit-table-helpers'

// Re-export for backward compatibility
export type { AuditRow }

interface EditState {
  storeId: string
  auditNumber: 1 | 2
  date: string
  percentage: string
  actionPlan: 'Yes' | 'No' | undefined
  pdfFile: File | null
}

interface UpdateScoreState {
  storeId: string
  auditNumber: 1 | 2
  storeName: string
  currentDate: string | null
  percentage: string
}

interface DeleteAuditPdfState {
  row: AuditRow
  auditNumber: 1 | 2
}

type DesktopDensity = 'dense' | 'comfortable'

const DESKTOP_DENSITY_STORAGE_KEY = 'fa_desktop_table_density'

function isDesktopDensity(value: string): value is DesktopDensity {
  return value === 'dense' || value === 'comfortable'
}

export function AuditTable({ 
  rows, 
  userRole, 
  areaFilter: externalAreaFilter, 
  onAreaFilterChange 
}: { 
  rows: AuditRow[]
  userRole: UserRole
  areaFilter?: string
  onAreaFilterChange?: (area: string) => void
}) {
  const [search, setSearch] = useState('')
  const [internalArea, setInternalArea] = useState<string>('all')
  const area = externalAreaFilter !== undefined ? externalAreaFilter : internalArea
  const setArea = onAreaFilterChange || setInternalArea
  const [hideCompleted, setHideCompleted] = useState(false)
  const [editing, setEditing] = useState<EditState | null>(null)
  const [saving, setSaving] = useState(false)
  const [localRows, setLocalRows] = useState<AuditRow[]>(rows)
  
  // Sync localRows with rows prop when it changes
  useEffect(() => {
    setLocalRows(rows)
  }, [rows])

  const [pdfViewerOpen, setPdfViewerOpen] = useState(false)
  const [selectedPdfRow, setSelectedPdfRow] = useState<{ row: AuditRow; auditNumber: 1 | 2 } | null>(null)
  const [pdfUploadDialogOpen, setPdfUploadDialogOpen] = useState(false)
  const [pdfUploadRow, setPdfUploadRow] = useState<AuditRow | null>(null)
  const [selectedAuditForUpload, setSelectedAuditForUpload] = useState<1 | 2 | null>(null)
  const [pdfUploadFile, setPdfUploadFile] = useState<File | null>(null)
  const [uploadingPdf, setUploadingPdf] = useState(false)
  const [deletingPdf, setDeletingPdf] = useState<string | null>(null)
  const [updateDialogOpen, setUpdateDialogOpen] = useState(false)
  const [updateScoreState, setUpdateScoreState] = useState<UpdateScoreState | null>(null)
  const [updatingScore, setUpdatingScore] = useState(false)
  const [updateScoreError, setUpdateScoreError] = useState<string | null>(null)
  const [desktopDensity, setDesktopDensity] = useState<DesktopDensity>('dense')
  const [mobileFiltersOpen, setMobileFiltersOpen] = useState(false)
  const [deletePdfDialog, setDeletePdfDialog] = useState<DeleteAuditPdfState | null>(null)
  const [tableMessage, setTableMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null)

  useEffect(() => {
    if (!tableMessage) return
    const timer = window.setTimeout(() => setTableMessage(null), 4000)
    return () => window.clearTimeout(timer)
  }, [tableMessage])

  useEffect(() => {
    try {
      const storedValue = window.localStorage.getItem(DESKTOP_DENSITY_STORAGE_KEY)
      if (storedValue && isDesktopDensity(storedValue)) {
        setDesktopDensity(storedValue)
      }
    } catch {
      // Ignore storage read issues (e.g. privacy mode restrictions).
    }
  }, [])

  useEffect(() => {
    try {
      window.localStorage.setItem(DESKTOP_DENSITY_STORAGE_KEY, desktopDensity)
    } catch {
      // Ignore storage write issues (e.g. privacy mode restrictions).
    }
  }, [desktopDensity])

  const areaOptions = useMemo(() => {
    const set = new Set<string>()
    rows.forEach((r) => r.region && set.add(r.region))
    return Array.from(set).sort()
  }, [rows])

  // Helper to check if both audits are complete
  const areBothAuditsComplete = (row: AuditRow): boolean => {
    const audit1Complete = !!(row.compliance_audit_1_date && row.compliance_audit_1_overall_pct !== null)
    const audit2Complete = !!(row.compliance_audit_2_date && row.compliance_audit_2_overall_pct !== null)
    return audit1Complete && audit2Complete
  }

  const filtered = useMemo(() => {
    return localRows.filter((row) => {
      const matchesArea = area === 'all' || row.region === area
      const term = search.trim().toLowerCase()
      const matchesSearch =
        term.length === 0 ||
        row.store_name.toLowerCase().includes(term) ||
        (row.store_code || '').toLowerCase().includes(term)
      const matchesCompletedFilter = !hideCompleted || !areBothAuditsComplete(row)
      return matchesArea && matchesSearch && matchesCompletedFilter
    })
  }, [localRows, area, search, hideCompleted])

  const grouped = useMemo(() => {
    const map = new Map<string, AuditRow[]>()
    
    // 1. Group by Region
    filtered.forEach((row) => {
      const key = row.region || 'Unassigned'
      if (!map.has(key)) map.set(key, [])
      map.get(key)!.push(row)
    })

    // 2. Sort STORES within each area by Latest % (Descending)
    map.forEach((storeRows) => {
      storeRows.sort((a, b) => getLatestPctForSort(b) - getLatestPctForSort(a))
    })

    // 3. Sort AREAS alphabetically
    return Array.from(map.entries()).sort(([a], [b]) => a.localeCompare(b))
  }, [filtered])

  const getNextAuditNumber = (row: AuditRow): 1 | 2 | null => {
    // Check if audit 1 has been completed (has both date and percentage)
    const audit1Complete = !!(row.compliance_audit_1_date && row.compliance_audit_1_overall_pct !== null)
    
    // Check if audit 2 has been completed (has both date and percentage)
    const audit2Complete = !!(row.compliance_audit_2_date && row.compliance_audit_2_overall_pct !== null)
    
    // If audit 1 hasn't been done yet, add audit 1
    if (!audit1Complete) {
      return 1
    }
    
    // If audit 1 is complete but audit 2 hasn't been done, add audit 2
    if (audit1Complete && !audit2Complete) {
      return 2
    }
    
    // Both audits are complete
    return null
  }

  const getCompletedAuditCount = (row: AuditRow): number => {
    let count = 0
    if (row.compliance_audit_1_date && row.compliance_audit_1_overall_pct !== null) count++
    if (row.compliance_audit_2_date && row.compliance_audit_2_overall_pct !== null) count++
    return count
  }

  const hasActiveFilters = search.trim().length > 0 || area !== 'all' || hideCompleted
  const activeFilterCount = Number(search.trim().length > 0) + Number(area !== 'all') + Number(hideCompleted)
  const desktopTableDensityClass = desktopDensity === 'dense' ? 'desktop-table-compact' : 'desktop-table-comfortable'

  const resetFilters = () => {
    setSearch('')
    setArea('all')
    setHideCompleted(false)
  }

  const handleAddAudit = (row: AuditRow) => {
    const auditNum = getNextAuditNumber(row)
    if (!auditNum) return // Both audits complete
    
    const currentDate = auditNum === 1 ? row.compliance_audit_1_date : row.compliance_audit_2_date
    const currentPct = auditNum === 1 ? row.compliance_audit_1_overall_pct : row.compliance_audit_2_overall_pct
    const currentActionPlan = auditNum === 1 ? row.action_plan_1_sent : row.action_plan_2_sent

    setEditing({
      storeId: row.id,
      auditNumber: auditNum,
      date: currentDate || new Date().toISOString().split('T')[0],
      percentage: currentPct?.toString() || '',
      actionPlan: currentActionPlan === true ? 'Yes' : currentActionPlan === false ? 'No' : undefined,
      pdfFile: null
    })
  }

  const handleCancelEdit = () => {
    setEditing(null)
  }

  const handleSaveAudit = async () => {
    if (!editing) return

    const { storeId, auditNumber, date, percentage, actionPlan, pdfFile } = editing

    // Validate
    if (!date) {
      setTableMessage({ type: 'error', text: 'Please enter an audit date.' })
      return
    }
    if (!percentage || isNaN(Number(percentage))) {
      setTableMessage({ type: 'error', text: 'Please enter a valid percentage (0-100).' })
      return
    }
    const pctNum = Number(percentage)
    if (pctNum < 0 || pctNum > 100) {
      setTableMessage({ type: 'error', text: 'Percentage must be between 0 and 100.' })
      return
    }
    if (!actionPlan || actionPlan === undefined) {
      setTableMessage({ type: 'error', text: 'Please select whether action plan was sent.' })
      return
    }

    setSaving(true)
    setTableMessage(null)
    const storeName = localRows.find((row) => row.id === storeId)?.store_name ?? 'store'

    try {
      const supabase = createClient()
      
      // Upload PDF if provided
      let pdfPath: string | null = null
      if (pdfFile) {
        try {
          // Use FormData to upload via API route
          const formData = new FormData()
          formData.append('storeId', storeId)
          formData.append('auditNumber', auditNumber.toString())
          formData.append('file', pdfFile)

          const response = await fetch('/api/audit-pdfs/upload', {
            method: 'POST',
            body: formData,
          })

          const result = await response.json()

          if (!response.ok) {
            throw new Error(result.error || 'Failed to upload PDF')
          }

          pdfPath = result.filePath
        } catch (uploadError) {
          console.error('PDF upload error:', uploadError)
          const uploadErrorMessage = uploadError instanceof Error ? uploadError.message : 'Unknown error'
          setTableMessage({ type: 'error', text: `Failed to upload PDF: ${uploadErrorMessage}` })
          return
        }
      }
      
      // Build update object
      const updateData: any = {}
      
      if (auditNumber === 1) {
        updateData.compliance_audit_1_date = date
        updateData.compliance_audit_1_overall_pct = pctNum
        updateData.action_plan_1_sent = actionPlan === 'Yes'
        if (pdfPath) {
          updateData.compliance_audit_1_pdf_path = pdfPath
        }
      } else {
        updateData.compliance_audit_2_date = date
        updateData.compliance_audit_2_overall_pct = pctNum
        updateData.action_plan_2_sent = actionPlan === 'Yes'
        if (pdfPath) {
          updateData.compliance_audit_2_pdf_path = pdfPath
        }
      }

      // Calculate total_audits_to_date
      const row = localRows.find(r => r.id === storeId)
      if (row) {
        let totalAudits = 0
        // Count audit 1 if it will be complete after this save
        const audit1Complete = auditNumber === 1 ? true : (row.compliance_audit_1_date && row.compliance_audit_1_overall_pct !== null)
        if (audit1Complete) totalAudits++
        // Count audit 2 if it will be complete after this save
        const audit2Complete = auditNumber === 2 ? true : (row.compliance_audit_2_date && row.compliance_audit_2_overall_pct !== null)
        if (audit2Complete) totalAudits++
        updateData.total_audits_to_date = totalAudits
      }

      const { data, error } = await supabase
        .from('fa_stores')
        .update(updateData)
        .eq('id', storeId)
        .select()
        .single()

      if (error) {
        console.error('Supabase error:', error)
        throw new Error(error.message || 'Failed to save audit data')
      }

      if (!data) {
        throw new Error('No data returned from update')
      }

      // Update local state with the returned data
      setLocalRows(prevRows => 
        prevRows.map(row => {
          if (row.id === storeId) {
            return {
              ...row,
              compliance_audit_1_date: data.compliance_audit_1_date,
              compliance_audit_1_overall_pct: data.compliance_audit_1_overall_pct,
              action_plan_1_sent: data.action_plan_1_sent,
              compliance_audit_1_pdf_path: data.compliance_audit_1_pdf_path,
              compliance_audit_2_date: data.compliance_audit_2_date,
              compliance_audit_2_overall_pct: data.compliance_audit_2_overall_pct,
              action_plan_2_sent: data.action_plan_2_sent,
              compliance_audit_2_pdf_path: data.compliance_audit_2_pdf_path,
              total_audits_to_date: data.total_audits_to_date,
            }
          }
          return row
        })
      )

      setEditing(null)
      setTableMessage({
        type: 'success',
        text: `Audit ${auditNumber} saved for ${storeName}.`,
      })
    } catch (error) {
      console.error('Error saving audit:', error)
      const errorMessage = error instanceof Error ? error.message : 'Failed to save audit. Please try again.'
      setTableMessage({ type: 'error', text: errorMessage })
    } finally {
      setSaving(false)
    }
  }

  const handleViewPDF = (row: AuditRow, auditNumber: 1 | 2) => {
    const pdfPath = auditNumber === 1 
      ? row.compliance_audit_1_pdf_path 
      : row.compliance_audit_2_pdf_path
    
    if (!pdfPath) return
    
    setSelectedPdfRow({ row, auditNumber })
    setPdfViewerOpen(true)
  }

  const handleGetPDFUrl = async () => {
    if (!selectedPdfRow) return null
    
    const pdfPath = selectedPdfRow.auditNumber === 1
      ? selectedPdfRow.row.compliance_audit_1_pdf_path
      : selectedPdfRow.row.compliance_audit_2_pdf_path
    
    if (!pdfPath) return null
    
    try {
      return await getAuditPDFDownloadUrl(pdfPath)
    } catch (error) {
      console.error('Error fetching PDF URL:', error)
      return null
    }
  }

  const handleOpenPDFUpload = (row: AuditRow, auditNumber?: 1 | 2) => {
    setPdfUploadRow(row)
    setPdfUploadFile(null)
    
    if (auditNumber) {
      // If audit number is provided, use it
      setSelectedAuditForUpload(auditNumber)
    } else {
      // Otherwise, auto-select if only one audit exists
      const hasAudit1 = !!(row.compliance_audit_1_date && row.compliance_audit_1_overall_pct !== null)
      const hasAudit2 = !!(row.compliance_audit_2_date && row.compliance_audit_2_overall_pct !== null)
      
      if (hasAudit1 && !hasAudit2) {
        setSelectedAuditForUpload(1)
      } else if (hasAudit2 && !hasAudit1) {
        setSelectedAuditForUpload(2)
      } else {
        // Both exist or neither exists - user must select
        setSelectedAuditForUpload(null)
      }
    }
    
    setPdfUploadDialogOpen(true)
  }

  const handlePDFFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0] || null
    setPdfUploadFile(file)
  }

  const handleUploadPDF = async () => {
    if (!pdfUploadRow || !pdfUploadFile || !selectedAuditForUpload) {
      setTableMessage({ type: 'error', text: 'Please select an audit and PDF file.' })
      return
    }

    const storeName = pdfUploadRow.store_name
    const selectedAudit = selectedAuditForUpload
    setUploadingPdf(true)
    setTableMessage(null)
    try {
      // Use FormData to upload via API route
      const formData = new FormData()
      formData.append('storeId', pdfUploadRow.id)
      formData.append('auditNumber', selectedAuditForUpload.toString())
      formData.append('file', pdfUploadFile)

      const response = await fetch('/api/audit-pdfs/upload', {
        method: 'POST',
        body: formData,
      })

      const result = await response.json()

      if (!response.ok) {
        throw new Error(result.error || 'Failed to upload PDF')
      }

      // Update local state
      setLocalRows(prevRows => prevRows.map(row => {
        if (row.id === pdfUploadRow.id) {
          return {
            ...row,
            compliance_audit_1_pdf_path: selectedAuditForUpload === 1 ? result.filePath : row.compliance_audit_1_pdf_path,
            compliance_audit_2_pdf_path: selectedAuditForUpload === 2 ? result.filePath : row.compliance_audit_2_pdf_path,
          }
        }
        return row
      }))

      setPdfUploadDialogOpen(false)
      setPdfUploadRow(null)
      setPdfUploadFile(null)
      setSelectedAuditForUpload(null)
      
      // Reset file input
      const fileInput = document.getElementById(`pdf-upload-standalone-${pdfUploadRow.id}`) as HTMLInputElement
      if (fileInput) fileInput.value = ''
      setTableMessage({
        type: 'success',
        text: `Audit ${selectedAudit} PDF uploaded for ${storeName}.`,
      })
    } catch (error) {
      console.error('Error uploading PDF:', error)
      const errorMessage = error instanceof Error ? error.message : 'Unknown error'
      setTableMessage({ type: 'error', text: `Failed to upload PDF: ${errorMessage}` })
    } finally {
      setUploadingPdf(false)
    }
  }

  const handleDeletePDF = (row: AuditRow, auditNumber: 1 | 2) => {
    setDeletePdfDialog({ row, auditNumber })
  }

  const handleConfirmDeletePDF = async () => {
    if (!deletePdfDialog) return
    const { row, auditNumber } = deletePdfDialog

    setDeletingPdf(`${row.id}-${auditNumber}`)
    setTableMessage(null)
    try {
      await deleteAuditPDF(row.id, auditNumber)
      
      // Update local state immediately
      setLocalRows(prevRows => prevRows.map(r => {
        if (r.id === row.id) {
          return {
            ...r,
            compliance_audit_1_pdf_path: auditNumber === 1 ? null : r.compliance_audit_1_pdf_path,
            compliance_audit_2_pdf_path: auditNumber === 2 ? null : r.compliance_audit_2_pdf_path,
          }
        }
        return r
      }))
      
      // Close PDF viewer if it's open for this row/audit
      if (selectedPdfRow?.row.id === row.id && selectedPdfRow.auditNumber === auditNumber) {
        setPdfViewerOpen(false)
        setSelectedPdfRow(null)
      }
      setDeletePdfDialog(null)
      setTableMessage({
        type: 'success',
        text: `Audit ${auditNumber} PDF deleted for ${row.store_name}.`,
      })
    } catch (error) {
      console.error('Error deleting PDF:', error)
      const errorMessage = error instanceof Error ? error.message : 'Unknown error'
      setTableMessage({ type: 'error', text: `Failed to delete PDF: ${errorMessage}` })
    } finally {
      setDeletingPdf(null)
    }
  }

  const handleOpenUpdateScore = (row: AuditRow, auditNumber: 1 | 2) => {
    const currentPct = auditNumber === 1 ? row.compliance_audit_1_overall_pct : row.compliance_audit_2_overall_pct
    const currentDate = auditNumber === 1 ? row.compliance_audit_1_date : row.compliance_audit_2_date

    if (currentPct === null || currentPct === undefined) return

    setUpdateScoreState({
      storeId: row.id,
      auditNumber,
      storeName: row.store_name,
      currentDate,
      percentage: currentPct.toString(),
    })
    setUpdateScoreError(null)
    setUpdateDialogOpen(true)
  }

  const handleUpdateScore = async () => {
    if (!updateScoreState) return

    const pctNum = Number(updateScoreState.percentage)
    if (!updateScoreState.percentage || isNaN(pctNum)) {
      setUpdateScoreError('Please enter a valid percentage (0-100).')
      return
    }
    if (pctNum < 0 || pctNum > 100) {
      setUpdateScoreError('Percentage must be between 0 and 100.')
      return
    }

    setUpdateScoreError(null)
    setUpdatingScore(true)

    try {
      const supabase = createClient()
      const updateData: Record<string, number> = {}

      if (updateScoreState.auditNumber === 1) {
        updateData.compliance_audit_1_overall_pct = pctNum
      } else {
        updateData.compliance_audit_2_overall_pct = pctNum
      }

      const { data, error } = await supabase
        .from('fa_stores')
        .update(updateData)
        .eq('id', updateScoreState.storeId)
        .select()
        .single()

      if (error) {
        console.error('Supabase error:', error)
        throw new Error(error.message || 'Failed to update audit score')
      }

      if (!data) {
        throw new Error('No data returned from update')
      }

      setLocalRows(prevRows => 
        prevRows.map(row => {
          if (row.id === updateScoreState.storeId) {
            return {
              ...row,
              compliance_audit_1_overall_pct: data.compliance_audit_1_overall_pct,
              compliance_audit_2_overall_pct: data.compliance_audit_2_overall_pct,
            }
          }
          return row
        })
      )

      setUpdateDialogOpen(false)
      setUpdateScoreState(null)
      setTableMessage({
        type: 'success',
        text: `Audit ${updateScoreState.auditNumber} score updated for ${updateScoreState.storeName}.`,
      })
    } catch (error) {
      console.error('Error updating audit score:', error)
      const errorMessage = error instanceof Error ? error.message : 'Failed to update audit score. Please try again.'
      setUpdateScoreError(errorMessage)
      setTableMessage({ type: 'error', text: errorMessage })
    } finally {
      setUpdatingScore(false)
    }
  }

  const renderDateCell = (date: string | null, pct: number | null, storeId: string, auditNum: 1 | 2, row: AuditRow) => {
    const isEditing = editing?.storeId === storeId && editing?.auditNumber === auditNum
    
    if (isEditing) {
      return (
        <Input
          type="date"
          value={editing.date}
          onChange={(e) => setEditing({ ...editing, date: e.target.value })}
          className="h-8 text-xs"
        />
      )
    }
    
    // Only show date if percentage is also present (audit is complete)
    // For audit 2, don't show date unless the audit is actually complete
    if (auditNum === 2 && pct === null) {
      return <span className="text-sm text-muted-foreground">—</span>
    }
    
    return <span className="text-sm text-muted-foreground">{formatDate(date)}</span>
  }

  const renderActionPlanCell = (value: boolean | null, storeId: string, auditNum: 1 | 2) => {
    const isEditing = editing?.storeId === storeId && editing?.auditNumber === auditNum
    
    if (isEditing) {
      return (
        <Select
          value={editing.actionPlan || undefined}
          onValueChange={(val) => setEditing({ ...editing, actionPlan: val as 'Yes' | 'No' })}
        >
          <SelectTrigger className="h-8 text-xs w-20">
            <SelectValue placeholder="Select" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="Yes">Yes</SelectItem>
            <SelectItem value="No">No</SelectItem>
          </SelectContent>
        </Select>
      )
    }
    
    return boolBadge(value)
  }

  const renderPercentageCell = (value: number | null, storeId: string, auditNum: 1 | 2) => {
    const isEditing = editing?.storeId === storeId && editing?.auditNumber === auditNum
    
    if (isEditing) {
      return (
        <Input
          type="number"
          min="0"
          max="100"
          step="0.01"
          value={editing.percentage}
          onChange={(e) => setEditing({ ...editing, percentage: e.target.value })}
          className="h-8 text-xs w-20"
          placeholder="0-100"
        />
      )
    }
    
    if (value === null || value === undefined) {
      return pctBadge(value)
    }

    return (
      <button
        type="button"
        onClick={() => {
          const row = localRows.find(r => r.id === storeId)
          if (row) handleOpenUpdateScore(row, auditNum)
        }}
        className="inline-flex items-center justify-center hover:opacity-80 transition-opacity"
        title="Update audit score"
      >
        {pctBadge(value)}
      </button>
    )
  }

  return (
    <div className="space-y-4">
      {/* Mobile Sticky Controls */}
      <div className="md:hidden sticky top-2 z-20 px-0.5">
        <div className={cn('mobile-sticky-shell rounded-2xl border px-3 py-2.5', mobileFiltersOpen && 'shadow-md')}>
          <div className="flex items-center justify-between gap-2">
            <Button
              variant="outline"
              size="sm"
              onClick={() => setMobileFiltersOpen((prev) => !prev)}
              className="h-8 px-2.5 text-xs border-slate-200 bg-white/80"
            >
              <SlidersHorizontal className="h-3.5 w-3.5 mr-1.5" />
              Filters
              {activeFilterCount > 0 ? (
                <span className="ml-1.5 inline-flex h-4 min-w-4 items-center justify-center rounded-full bg-slate-900 px-1 text-[10px] text-white">
                  {activeFilterCount}
                </span>
              ) : null}
              {mobileFiltersOpen ? (
                <ChevronUp className="h-3.5 w-3.5 ml-1.5" />
              ) : (
                <ChevronDown className="h-3.5 w-3.5 ml-1.5" />
              )}
            </Button>
            <div className="rounded-full bg-white/80 border border-slate-200 px-2.5 py-1 text-[11px] text-slate-600 font-medium">
              {filtered.length} of {localRows.length}
            </div>
          </div>

          {mobileFiltersOpen ? (
            <div className="mt-3 space-y-2 border-t pt-3">
              <Input
                placeholder="Search store name or code"
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                className="bg-white min-h-[var(--touch-target-min)]"
              />
              <Select value={area} onValueChange={setArea}>
                <SelectTrigger className="w-full bg-white min-h-[var(--touch-target-min)]">
                  <SelectValue placeholder="Area" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">All areas</SelectItem>
                  {areaOptions.map((opt) => (
                    <SelectItem key={opt} value={opt}>{opt}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
              <div className="flex gap-2">
                <Button
                  variant={hideCompleted ? 'default' : 'outline'}
                  onClick={() => setHideCompleted(!hideCompleted)}
                  className={cn(
                    'flex-1 min-h-[var(--touch-target-min)]',
                    hideCompleted ? 'bg-slate-900 text-white hover:bg-slate-800' : 'border-slate-200 bg-white'
                  )}
                >
                  {hideCompleted ? (
                    <>
                      <EyeOff className="h-4 w-4 mr-2" />
                      Show Completed
                    </>
                  ) : (
                    <>
                      <Eye className="h-4 w-4 mr-2" />
                      Hide Completed
                    </>
                  )}
                </Button>
                <Button
                  variant="ghost"
                  onClick={resetFilters}
                  disabled={!hasActiveFilters}
                  className="min-h-[var(--touch-target-min)] text-slate-600"
                >
                  Reset
                </Button>
              </div>
            </div>
          ) : null}
        </div>
      </div>

      {/* Desktop Controls */}
      <div className="hidden md:flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div className="flex flex-col sm:flex-row gap-3 w-full md:w-auto">
          <Input
            placeholder="Search store name or code"
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="flex-1 md:w-64 bg-white min-h-[var(--touch-target-min)]"
          />
          <Select value={area} onValueChange={setArea}>
            <SelectTrigger className="w-full sm:w-40 bg-white min-h-[var(--touch-target-min)]">
              <SelectValue placeholder="Area" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">All areas</SelectItem>
              {areaOptions.map((opt) => (
                <SelectItem key={opt} value={opt}>{opt}</SelectItem>
              ))}
            </SelectContent>
          </Select>
          <Button
            variant={hideCompleted ? "default" : "outline"}
            onClick={() => setHideCompleted(!hideCompleted)}
            className="min-h-[var(--touch-target-min)]"
          >
            {hideCompleted ? (
              <>
                <EyeOff className="h-4 w-4 mr-2" />
                <span className="hidden sm:inline">Show Completed</span>
                <span className="sm:hidden">Show</span>
              </>
            ) : (
              <>
                <Eye className="h-4 w-4 mr-2" />
                <span className="hidden sm:inline">Hide Completed</span>
                <span className="sm:hidden">Hide</span>
              </>
            )}
          </Button>
          <Button
            variant="ghost"
            onClick={resetFilters}
            disabled={!hasActiveFilters}
            className="min-h-[var(--touch-target-min)]"
          >
            Reset
          </Button>
        </div>
        <div className="flex items-center gap-3">
          <div className="inline-flex rounded-lg border border-slate-200 bg-white p-1">
            <button
              type="button"
              onClick={() => setDesktopDensity('dense')}
              className={cn(
                'rounded-md px-2.5 py-1 text-xs font-medium transition-colors',
                desktopDensity === 'dense'
                  ? 'bg-slate-900 text-white'
                  : 'text-slate-600 hover:bg-slate-100'
              )}
            >
              Dense
            </button>
            <button
              type="button"
              onClick={() => setDesktopDensity('comfortable')}
              className={cn(
                'rounded-md px-2.5 py-1 text-xs font-medium transition-colors',
                desktopDensity === 'comfortable'
                  ? 'bg-slate-900 text-white'
                  : 'text-slate-600 hover:bg-slate-100'
              )}
            >
              Comfortable
            </button>
          </div>
          <div className="text-sm text-muted-foreground">
            Showing {filtered.length} of {localRows.length} stores
          </div>
        </div>
      </div>

      {tableMessage ? (
        <div
          className={cn(
            'rounded-lg border px-3 py-2 text-sm',
            tableMessage.type === 'success'
              ? 'border-emerald-200 bg-emerald-50 text-emerald-800'
              : 'border-rose-200 bg-rose-50 text-rose-800'
          )}
        >
          {tableMessage.text}
        </div>
      ) : null
      }

      {/* Mobile Card View */}
      <div className="md:hidden space-y-3">
        {grouped.length === 0 ? (
          <div className="rounded-2xl border bg-white px-4 py-8 text-center text-sm text-muted-foreground">
            No audit data found matching your filters.
          </div>
        ) : (
          grouped.map(([groupKey, areaRows]) => {
            const validScores = areaRows
              .map((row) => getLatestPct(row))
              .filter((score): score is number => score !== null)
            const totalScore = validScores.reduce((acc, cur) => acc + cur, 0)
            const calculatedAverage = validScores.length > 0 ? totalScore / validScores.length : null

            return (
              <div key={`mob-${groupKey}`} className="space-y-2.5">
                <div className="mobile-group-bar flex items-center justify-between rounded-xl border px-3 py-2">
                  <span className="text-sm font-semibold text-slate-800">{groupKey}</span>
                  <div className="flex items-center gap-2">
                    <span className="text-[10px] font-semibold uppercase tracking-wide text-slate-500">
                      Avg
                    </span>
                    {pctBadge(calculatedAverage)}
                  </div>
                </div>

                <div className="space-y-2.5">
                  {areaRows.map((row) => {
                    const isEditingRow = editing?.storeId === row.id
                    const nextAudit = getNextAuditNumber(row)
                    const completedCount = getCompletedAuditCount(row)

                    return (
                      <div key={row.id} className="mobile-card-surface rounded-2xl border p-3.5 shadow-sm">
                        <div className="flex items-start justify-between gap-3">
                          <div className="min-w-0">
                            <div className="text-sm font-semibold text-slate-900 truncate leading-tight">
                              {row.store_name}
                            </div>
                            <div className="mt-1 flex items-center gap-1.5 text-[11px] text-slate-500">
                              <span className="rounded-md bg-slate-100 px-1.5 py-0.5 font-mono">
                                {row.store_code || '—'}
                              </span>
                              <span>{row.region || 'Unassigned'}</span>
                            </div>
                          </div>
                          <div className="rounded-full border border-slate-200 bg-white px-2 py-0.5 text-[11px] font-medium text-slate-500">
                            {completedCount}/2 complete
                          </div>
                        </div>

                        <div className="mt-3 grid grid-cols-2 gap-2">
                          <div className="rounded-xl border bg-white/90 px-2.5 py-2">
                            <div className="text-[10px] uppercase tracking-wide text-slate-500">Audit 1</div>
                            <div className="mt-1 text-xs text-slate-700 leading-tight">
                              {formatDate(row.compliance_audit_1_date)}
                            </div>
                            <div className="mt-1">{pctBadge(row.compliance_audit_1_overall_pct)}</div>
                          </div>
                          <div className="rounded-xl border bg-white/90 px-2.5 py-2">
                            <div className="text-[10px] uppercase tracking-wide text-slate-500">Audit 2</div>
                            <div className="mt-1 text-xs text-slate-700 leading-tight">
                              {formatDate(row.compliance_audit_2_date)}
                            </div>
                            <div className="mt-1">{pctBadge(row.compliance_audit_2_overall_pct)}</div>
                          </div>
                        </div>

                        {isEditingRow ? (
                          <div className="mt-3 space-y-2.5 border-t border-slate-200/80 pt-3">
                            <div className="text-xs font-semibold text-slate-700">
                              Adding Audit {editing?.auditNumber}
                            </div>
                            <Input
                              type="date"
                              value={editing?.date || ''}
                              onChange={(e) => setEditing((prev) => prev ? { ...prev, date: e.target.value } : prev)}
                              className="bg-white"
                            />
                            <Select
                              value={editing?.actionPlan || undefined}
                              onValueChange={(val) => setEditing((prev) => prev ? { ...prev, actionPlan: val as 'Yes' | 'No' } : prev)}
                            >
                              <SelectTrigger className="bg-white">
                                <SelectValue placeholder="Action plan sent?" />
                              </SelectTrigger>
                              <SelectContent>
                                <SelectItem value="Yes">Action plan sent: Yes</SelectItem>
                                <SelectItem value="No">Action plan sent: No</SelectItem>
                              </SelectContent>
                            </Select>
                            <Input
                              type="number"
                              min="0"
                              max="100"
                              step="0.01"
                              value={editing?.percentage || ''}
                              onChange={(e) => setEditing((prev) => prev ? { ...prev, percentage: e.target.value } : prev)}
                              placeholder="Score (0-100)"
                              className="bg-white"
                            />

                            <div className="flex items-center gap-2">
                              <input
                                type="file"
                                id={`pdf-upload-mobile-${row.id}`}
                                accept=".pdf,application/pdf"
                                onChange={(e) => {
                                  const file = e.target.files?.[0] || null
                                  setEditing((prev) => prev ? { ...prev, pdfFile: file } : prev)
                                }}
                                className="hidden"
                                disabled={saving}
                              />
                              <Button
                                size="sm"
                                variant="outline"
                                type="button"
                                onClick={() => document.getElementById(`pdf-upload-mobile-${row.id}`)?.click()}
                                disabled={saving}
                                className="border-slate-300 bg-white"
                              >
                                <Upload className="h-3 w-3 mr-1" />
                                Upload PDF
                              </Button>
                              {editing?.pdfFile ? (
                                <span className="text-xs text-slate-500 truncate">{editing.pdfFile.name}</span>
                              ) : null}
                            </div>

                            <div className="flex gap-2">
                              <Button size="sm" onClick={handleSaveAudit} disabled={saving} className="flex-1 bg-slate-900 text-white hover:bg-slate-800">
                                {saving ? 'Saving...' : 'Save'}
                              </Button>
                              <Button size="sm" variant="outline" onClick={handleCancelEdit} disabled={saving} className="flex-1 border-slate-300 bg-white">
                                Cancel
                              </Button>
                            </div>
                          </div>
                        ) : (
                          <div className="mt-3 space-y-2.5 border-t border-slate-200/80 pt-3">
                            {nextAudit !== null ? (
                              <Button
                                size="sm"
                                onClick={() => handleAddAudit(row)}
                                className="w-full bg-slate-900 text-white hover:bg-slate-800"
                              >
                                Add Audit
                              </Button>
                            ) : null}

                            {(row.compliance_audit_1_date && row.compliance_audit_1_overall_pct !== null) ||
                            (row.compliance_audit_2_date && row.compliance_audit_2_overall_pct !== null) ? (
                              <div className="space-y-1">
                                <div className="text-[10px] uppercase tracking-wide text-slate-500">Audit PDFs</div>
                                <div className="flex flex-wrap items-center gap-2">
                                  {row.compliance_audit_1_date && row.compliance_audit_1_overall_pct !== null ? (
                                    row.compliance_audit_1_pdf_path ? (
                                      <>
                                        <Button
                                          size="sm"
                                          variant="ghost"
                                          onClick={() => handleViewPDF(row, 1)}
                                          className="h-8 border border-slate-200 bg-white px-2.5 text-xs text-slate-700 hover:bg-slate-50"
                                        >
                                          <File className="h-3.5 w-3.5 mr-1" />
                                          Audit 1
                                        </Button>
                                        <Button
                                          size="sm"
                                          variant="ghost"
                                          onClick={() => handleDeletePDF(row, 1)}
                                          disabled={deletingPdf === `${row.id}-1`}
                                          className="h-8 border border-rose-200 bg-rose-50 px-2 text-rose-700 hover:bg-rose-100"
                                          title="Delete Audit 1 PDF"
                                        >
                                          <Trash2 className="h-3.5 w-3.5" />
                                        </Button>
                                      </>
                                    ) : (
                                      <Button size="sm" variant="outline" onClick={() => handleOpenPDFUpload(row, 1)} className="h-8 border-slate-300 bg-white">
                                        <Upload className="h-3 w-3 mr-1" />
                                        Upload A1 PDF
                                      </Button>
                                    )
                                  ) : null}

                                  {row.compliance_audit_2_date && row.compliance_audit_2_overall_pct !== null ? (
                                    row.compliance_audit_2_pdf_path ? (
                                      <>
                                        <Button
                                          size="sm"
                                          variant="ghost"
                                          onClick={() => handleViewPDF(row, 2)}
                                          className="h-8 border border-slate-200 bg-white px-2.5 text-xs text-slate-700 hover:bg-slate-50"
                                        >
                                          <File className="h-3.5 w-3.5 mr-1" />
                                          Audit 2
                                        </Button>
                                        <Button
                                          size="sm"
                                          variant="ghost"
                                          onClick={() => handleDeletePDF(row, 2)}
                                          disabled={deletingPdf === `${row.id}-2`}
                                          className="h-8 border border-rose-200 bg-rose-50 px-2 text-rose-700 hover:bg-rose-100"
                                          title="Delete Audit 2 PDF"
                                        >
                                          <Trash2 className="h-3.5 w-3.5" />
                                        </Button>
                                      </>
                                    ) : (
                                      <Button size="sm" variant="outline" onClick={() => handleOpenPDFUpload(row, 2)} className="h-8 border-slate-300 bg-white">
                                        <Upload className="h-3 w-3 mr-1" />
                                        Upload A2 PDF
                                      </Button>
                                    )
                                  ) : null}
                                </div>
                              </div>
                            ) : null}
                          </div>
                        )}
                      </div>
                    )
                  })}
                </div>
              </div>
            )
          })
        )}
      </div>

      {/* Desktop Table Container */}
      <div className="hidden md:flex rounded-2xl border desktop-table-shell shadow-sm overflow-hidden flex-col">
        <div className="overflow-x-auto -mx-4 px-4 md:mx-0 md:px-0">
          <div className={cn(desktopDensity === 'dense' ? 'min-w-[940px]' : 'min-w-[1000px]')}>
            <Table className={cn('w-full border-separate border-spacing-0', desktopTableDensityClass)} style={{ tableLayout: 'fixed' }}>
              <colgroup>
                <col style={{ width: '32px' }} />
                <col style={{ width: '54px' }} />
                <col style={{ width: '68px' }} />
                <col style={{ width: '132px' }} />
                <col style={{ width: '92px' }} />
                <col style={{ width: '72px' }} />
                <col style={{ width: '60px' }} />
                <col style={{ width: '44px' }} />
                <col style={{ width: '92px' }} />
                <col style={{ width: '72px' }} />
                <col style={{ width: '60px' }} />
                <col style={{ width: '44px' }} />
                <col style={{ width: '58px' }} />
                <col style={{ width: '116px' }} />
              </colgroup>
              <TableHeader className="desktop-table-head border-b border-slate-200">
                <TableRow className="hover:bg-transparent">
                  <TableHead className="text-center bg-transparent text-[11px] font-semibold uppercase tracking-wide text-slate-500">#</TableHead>
                  <TableHead className="bg-transparent text-[11px] font-semibold uppercase tracking-wide text-slate-500">Area</TableHead>
                  <TableHead className="bg-transparent text-[11px] font-semibold uppercase tracking-wide text-slate-500">Store Code</TableHead>
                  <TableHead className="bg-transparent text-[11px] font-semibold uppercase tracking-wide text-slate-500">Store Name</TableHead>
                  <TableHead className="bg-transparent text-[11px] font-semibold uppercase tracking-wide text-slate-500">Audit 1 Date</TableHead>
                  <TableHead className="bg-transparent text-[11px] font-semibold uppercase tracking-wide text-slate-500">Action Plan 1</TableHead>
                  <TableHead className="bg-transparent text-[11px] font-semibold uppercase tracking-wide text-slate-500">Audit 1 %</TableHead>
                  <TableHead className="bg-transparent text-center text-[11px] font-semibold uppercase tracking-wide text-slate-500">PDF</TableHead>
                  <TableHead className="bg-transparent text-[11px] font-semibold uppercase tracking-wide text-slate-500">Audit 2 Date</TableHead>
                  <TableHead className="bg-transparent text-[11px] font-semibold uppercase tracking-wide text-slate-500">Action Plan 2</TableHead>
                  <TableHead className="bg-transparent text-[11px] font-semibold uppercase tracking-wide text-slate-500">Audit 2 %</TableHead>
                  <TableHead className="bg-transparent text-center text-[11px] font-semibold uppercase tracking-wide text-slate-500">PDF</TableHead>
                  <TableHead className="text-right pr-4 bg-transparent text-[11px] font-semibold uppercase tracking-wide text-slate-500">Total Audits</TableHead>
                  <TableHead className="bg-transparent text-[11px] font-semibold uppercase tracking-wide text-slate-500">Actions</TableHead>
                </TableRow>
              </TableHeader>
            </Table>
            <div className={cn(desktopDensity === 'dense' ? 'h-[74vh]' : 'h-[70vh]', 'overflow-y-auto')}>
              <Table className={cn('w-full border-separate border-spacing-0', desktopTableDensityClass)} style={{ tableLayout: 'fixed' }}>
                <colgroup>
                  <col style={{ width: '32px' }} />
                  <col style={{ width: '54px' }} />
                  <col style={{ width: '68px' }} />
                  <col style={{ width: '132px' }} />
                  <col style={{ width: '92px' }} />
                  <col style={{ width: '72px' }} />
                  <col style={{ width: '60px' }} />
                  <col style={{ width: '44px' }} />
                  <col style={{ width: '92px' }} />
                  <col style={{ width: '72px' }} />
                  <col style={{ width: '60px' }} />
                  <col style={{ width: '44px' }} />
                  <col style={{ width: '58px' }} />
                  <col style={{ width: '116px' }} />
                </colgroup>
                <TableBody>
              {grouped.length === 0 ? (
                <TableRow>
                  <TableCell colSpan={14} className="text-center text-muted-foreground py-10">
                    No audit data found matching your filters.
                  </TableCell>
                </TableRow>
              ) : (
                grouped.map(([groupKey, areaRows]) => {
                  
                  // --- CALCULATE AREA AVERAGE DYNAMICALLY ---
                  // 1. Map rows to their latest percentage
                  const validScores = areaRows
                    .map(r => getLatestPct(r))
                    .filter((score): score is number => score !== null);
                  
                  // 2. Calculate Average
                  const totalScore = validScores.reduce((acc, cur) => acc + cur, 0);
                  const calculatedAverage = validScores.length > 0 
                    ? totalScore / validScores.length 
                    : null;
                  
                  return (
                    <>
                      {/* Area Divider Row */}
                      <TableRow key={`hdr-${groupKey}`} className="desktop-group-bar hover:bg-transparent">
                        <TableCell 
                          colSpan={14} 
                          className="py-1.5 px-4 border-y border-slate-200/70"
                        >
                          <div className="flex items-center justify-between w-full">
                            <span className="font-bold text-slate-700">{groupKey}</span>
                            <div className="flex items-center gap-3">
                              <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                Area Average ({validScores.length} stores)
                              </span>
                              {pctBadge(calculatedAverage)}
                            </div>
                          </div>
                        </TableCell>
                      </TableRow>

                      {/* Store Rows */}
                      {areaRows.map((row, idx) => (
                        <TableRow
                          key={row.id}
                          className="group transition-colors hover:bg-slate-50/70"
                        >
                          <TableCell className="font-mono text-xs text-center text-muted-foreground border-b bg-white group-hover:bg-slate-50">
                            {idx + 1}
                          </TableCell>
                          <TableCell className="text-xs text-muted-foreground border-b bg-white group-hover:bg-slate-50">
                            {row.region || '—'}
                          </TableCell>
                          <TableCell className="font-mono text-xs font-medium border-b bg-white group-hover:bg-slate-50">
                            {row.store_code || '—'}
                          </TableCell>
                          <TableCell className="font-semibold text-sm border-b bg-white group-hover:bg-slate-50">
                            {row.store_name}
                          </TableCell>
                          
                          <TableCell className="border-b bg-white group-hover:bg-slate-50">{renderDateCell(row.compliance_audit_1_date, row.compliance_audit_1_overall_pct, row.id, 1, row)}</TableCell>
                          <TableCell className="border-b bg-white group-hover:bg-slate-50">{renderActionPlanCell(row.action_plan_1_sent, row.id, 1)}</TableCell>
                          <TableCell className="border-b bg-white group-hover:bg-slate-50">{renderPercentageCell(row.compliance_audit_1_overall_pct, row.id, 1)}</TableCell>
                          <TableCell className="border-b bg-white group-hover:bg-slate-50 text-center">
                            <div className="flex items-center justify-center gap-1">
                              {row.compliance_audit_1_pdf_path ? (
                                <>
                                  <Button
                                    size="sm"
                                    variant="ghost"
                                    onClick={() => handleViewPDF(row, 1)}
                                    className="h-7 border border-slate-200 bg-white px-2 hover:bg-slate-50"
                                    title="View Audit 1 PDF"
                                  >
                                    <File className="h-4 w-4 text-slate-700" />
                                  </Button>
                                  <Button
                                    size="sm"
                                    variant="ghost"
                                    onClick={() => handleDeletePDF(row, 1)}
                                    disabled={deletingPdf === `${row.id}-1`}
                                    className="h-7 border border-rose-200 bg-rose-50 px-1 text-rose-700 hover:bg-rose-100"
                                    title="Delete Audit 1 PDF"
                                  >
                                    <Trash2 className="h-3 w-3" />
                                  </Button>
                                </>
                              ) : (row.compliance_audit_1_date && row.compliance_audit_1_overall_pct !== null) ? (
                                <Button
                                  size="sm"
                                  variant="ghost"
                                  onClick={() => handleOpenPDFUpload(row, 1)}
                                  className="h-7 border border-slate-300 bg-white px-2 text-xs hover:bg-slate-50"
                                  title="Upload Audit 1 PDF"
                                >
                                  <Upload className="h-3 w-3 text-slate-600" />
                                </Button>
                              ) : (
                                <span className="text-sm text-muted-foreground">—</span>
                              )}
                            </div>
                          </TableCell>
                          
                          <TableCell className="border-b bg-white group-hover:bg-slate-50">{renderDateCell(row.compliance_audit_2_date, row.compliance_audit_2_overall_pct, row.id, 2, row)}</TableCell>
                          <TableCell className="border-b bg-white group-hover:bg-slate-50">{renderActionPlanCell(row.action_plan_2_sent, row.id, 2)}</TableCell>
                          <TableCell className="border-b bg-white group-hover:bg-slate-50">{renderPercentageCell(row.compliance_audit_2_overall_pct, row.id, 2)}</TableCell>
                          <TableCell className="border-b bg-white group-hover:bg-slate-50 text-center">
                            <div className="flex items-center justify-center gap-1">
                              {row.compliance_audit_2_pdf_path ? (
                                <>
                                  <Button
                                    size="sm"
                                    variant="ghost"
                                    onClick={() => handleViewPDF(row, 2)}
                                    className="h-7 border border-slate-200 bg-white px-2 hover:bg-slate-50"
                                    title="View Audit 2 PDF"
                                  >
                                    <File className="h-4 w-4 text-slate-700" />
                                  </Button>
                                  <Button
                                    size="sm"
                                    variant="ghost"
                                    onClick={() => handleDeletePDF(row, 2)}
                                    disabled={deletingPdf === `${row.id}-2`}
                                    className="h-7 border border-rose-200 bg-rose-50 px-1 text-rose-700 hover:bg-rose-100"
                                    title="Delete Audit 2 PDF"
                                  >
                                    <Trash2 className="h-3 w-3" />
                                  </Button>
                                </>
                              ) : (row.compliance_audit_2_date && row.compliance_audit_2_overall_pct !== null) ? (
                                <Button
                                  size="sm"
                                  variant="ghost"
                                  onClick={() => handleOpenPDFUpload(row, 2)}
                                  className="h-7 border border-slate-300 bg-white px-2 text-xs hover:bg-slate-50"
                                  title="Upload Audit 2 PDF"
                                >
                                  <Upload className="h-3 w-3 text-slate-600" />
                                </Button>
                              ) : (
                                <span className="text-sm text-muted-foreground">—</span>
                              )}
                            </div>
                          </TableCell>
                          
                          <TableCell className="text-right pr-4 font-mono text-xs text-muted-foreground border-b bg-white group-hover:bg-slate-50">
                            {getCompletedAuditCount(row)}
                          </TableCell>
                          
                          <TableCell className="border-b bg-white group-hover:bg-slate-50">
                            {editing?.storeId === row.id ? (
                              <div className="flex flex-col gap-1.5 min-w-[180px]">
                                <div className="flex gap-1 flex-wrap">
                                  <Button
                                    size="sm"
                                    variant="default"
                                    onClick={handleSaveAudit}
                                    disabled={saving}
                                    className="h-7 bg-slate-900 px-2 text-xs text-white whitespace-nowrap hover:bg-slate-800"
                                  >
                                    {saving ? 'Saving...' : 'Save'}
                                  </Button>
                                  <Button
                                    size="sm"
                                    variant="outline"
                                    onClick={handleCancelEdit}
                                    disabled={saving}
                                    className="h-7 border-slate-300 bg-white px-2 text-xs whitespace-nowrap hover:bg-slate-50"
                                  >
                                    Cancel
                                  </Button>
                                </div>
                                <div className="relative">
                                  <input
                                    type="file"
                                    id={`pdf-upload-${row.id}`}
                                    accept=".pdf,application/pdf"
                                    onChange={(e) => {
                                      const file = e.target.files?.[0] || null
                                      if (editing) {
                                        setEditing({ ...editing, pdfFile: file })
                                      }
                                    }}
                                    className="hidden"
                                    disabled={saving}
                                  />
                                  <Button
                                    size="sm"
                                    variant="outline"
                                    type="button"
                                    onClick={() => document.getElementById(`pdf-upload-${row.id}`)?.click()}
                                    disabled={saving}
                                    className="h-6 w-fit border-slate-300 bg-white px-1.5 text-[11px] hover:bg-slate-50"
                                  >
                                    <Upload className="h-2.5 w-2.5 mr-1" />
                                    {editing?.pdfFile ? editing.pdfFile.name.substring(0, 12) + '...' : 'Upload PDF'}
                                  </Button>
                                </div>
                              </div>
                            ) : (
                              getNextAuditNumber(row) !== null && (
                                <Button
                                  size="sm"
                                  variant="default"
                                  onClick={() => handleAddAudit(row)}
                                  className="h-7 bg-slate-900 px-2 text-xs text-white whitespace-nowrap hover:bg-slate-800"
                                >
                                  Add Audit
                                </Button>
                              )
                            )}
                          </TableCell>
                        </TableRow>
                      ))}
                    </>
                  )
                })
              )}
            </TableBody>
          </Table>
        </div>
      </div>
    </div>
  </div>
      
      {/* PDF Viewer Modal */}
      <PDFViewerModal
        open={pdfViewerOpen}
        onOpenChange={setPdfViewerOpen}
        pdfUrl={null}
        title={selectedPdfRow ? `Audit ${selectedPdfRow.auditNumber} - ${selectedPdfRow.row.store_name}` : 'Audit PDF'}
        getDownloadUrl={handleGetPDFUrl}
      />

      {/* PDF Upload Dialog */}
      <Dialog open={pdfUploadDialogOpen} onOpenChange={setPdfUploadDialogOpen}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader>
            <DialogTitle>Upload Audit PDF</DialogTitle>
            <DialogDescription>
              {pdfUploadRow?.store_name}
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4 py-4">
            {/* Select Audit Number - only show if both audits exist */}
            {pdfUploadRow && 
             (pdfUploadRow.compliance_audit_1_date && pdfUploadRow.compliance_audit_1_overall_pct !== null) &&
             (pdfUploadRow.compliance_audit_2_date && pdfUploadRow.compliance_audit_2_overall_pct !== null) ? (
              <div className="space-y-2">
                <label className="text-sm font-medium">Select Audit</label>
                <Select
                  value={selectedAuditForUpload?.toString() || ''}
                  onValueChange={(value) => setSelectedAuditForUpload(parseInt(value) as 1 | 2)}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Select audit..." />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="1">Audit 1</SelectItem>
                    <SelectItem value="2">Audit 2</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            ) : (
              <div className="text-sm text-muted-foreground">
                {selectedAuditForUpload === 1 && 'Uploading to Audit 1'}
                {selectedAuditForUpload === 2 && 'Uploading to Audit 2'}
                {!selectedAuditForUpload && 'Please select an audit'}
              </div>
            )}

            {/* File Input */}
            <div className="space-y-2">
              <label className="text-sm font-medium">PDF File</label>
              <input
                type="file"
                id={`pdf-upload-standalone-${pdfUploadRow?.id}`}
                accept=".pdf,application/pdf"
                onChange={handlePDFFileSelect}
                className="w-full text-sm"
              />
              {pdfUploadFile && (
                <p className="text-xs text-muted-foreground">{pdfUploadFile.name}</p>
              )}
            </div>
          </div>

          <DialogFooter>
            <Button
              variant="outline"
              onClick={() => {
                setPdfUploadDialogOpen(false)
                setPdfUploadRow(null)
                setPdfUploadFile(null)
                setSelectedAuditForUpload(null)
              }}
            >
              Cancel
            </Button>
            <Button
              onClick={handleUploadPDF}
              disabled={!pdfUploadFile || !selectedAuditForUpload || uploadingPdf}
            >
              {uploadingPdf ? 'Uploading...' : 'Upload'}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Delete PDF Dialog */}
      <Dialog
        open={!!deletePdfDialog}
        onOpenChange={(open) => {
          if (!open) {
            setDeletePdfDialog(null)
          }
        }}
      >
        <DialogContent className="sm:max-w-sm">
          <DialogHeader>
            <DialogTitle>Delete Audit PDF</DialogTitle>
            <DialogDescription>
              {deletePdfDialog
                ? `Remove Audit ${deletePdfDialog.auditNumber} PDF for ${deletePdfDialog.row.store_name}?`
                : ''}
            </DialogDescription>
          </DialogHeader>
          <DialogFooter>
            <Button
              variant="outline"
              onClick={() => setDeletePdfDialog(null)}
              disabled={!!deletingPdf}
            >
              Cancel
            </Button>
            <Button
              variant="destructive"
              onClick={handleConfirmDeletePDF}
              disabled={
                !deletePdfDialog ||
                deletingPdf === `${deletePdfDialog.row.id}-${deletePdfDialog.auditNumber}`
              }
            >
              {deletePdfDialog &&
              deletingPdf === `${deletePdfDialog.row.id}-${deletePdfDialog.auditNumber}`
                ? 'Deleting...'
                : 'Delete PDF'}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Update Score Dialog */}
      <Dialog
        open={updateDialogOpen}
        onOpenChange={(open) => {
          setUpdateDialogOpen(open)
          if (!open) {
            setUpdateScoreState(null)
            setUpdateScoreError(null)
          }
        }}
      >
        <DialogContent className="sm:max-w-sm">
          <DialogHeader>
            <DialogTitle>Update Audit Score</DialogTitle>
            <DialogDescription>
              {updateScoreState ? `Audit ${updateScoreState.auditNumber} - ${updateScoreState.storeName}` : ''}
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4 py-2">
            {updateScoreState?.currentDate && (
              <div className="text-xs text-muted-foreground">
                Audit date: {formatDate(updateScoreState.currentDate)}
              </div>
            )}
            <div className="space-y-2">
              <label className="text-sm font-medium">Score (%)</label>
              <Input
                type="number"
                min="0"
                max="100"
                step="0.01"
                value={updateScoreState?.percentage || ''}
                onChange={(e) => {
                  if (!updateScoreState) return
                  setUpdateScoreState({ ...updateScoreState, percentage: e.target.value })
                }}
              />
            </div>
            {updateScoreError ? (
              <p className="text-sm text-rose-600">{updateScoreError}</p>
            ) : null}
          </div>
          <DialogFooter>
            <Button
              variant="outline"
              onClick={() => {
                setUpdateDialogOpen(false)
                setUpdateScoreState(null)
                setUpdateScoreError(null)
              }}
              disabled={updatingScore}
            >
              Cancel
            </Button>
            <Button onClick={handleUpdateScore} disabled={updatingScore}>
              {updatingScore ? 'Updating...' : 'Update'}
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  )
}
